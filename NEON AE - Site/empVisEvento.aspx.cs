using System;using System.Collections.Generic;using System.Linq;using System.Web;using System.Web.UI;using System.Web.UI.WebControls;using System.Data;using System.IO;using System.Drawing; public partial class empVisEvento : System.Web.UI.Page { Criptografia cripto = new Criptografia("NEON"); protected void Page_Load(object sender, EventArgs e) { if (!IsPostBack) { DataView dv = (DataView)sqlVisEventos.Select(DataSourceSelectArguments.Empty); if (dv.Table.Rows.Count <= 0){Response.Redirect("empEventos.aspx");} else { imgEvento.ImageUrl = "~//img//uploaded//" + cripto.Decrypt(dv.Table.Rows[0]["img"].ToString()); txtAltNome.Text = cripto.Decrypt(dv.Table.Rows[0]["nome_evento"].ToString()); txtAltCidade.Text = cripto.Decrypt(dv.Table.Rows[0]["cid"].ToString()); txtAltDetalhes.Text = cripto.Decrypt(dv.Table.Rows[0]["detalhes_even"].ToString()); txtAltLocal.Text = cripto.Decrypt(dv.Table.Rows[0]["local"].ToString()); txtAltRua.Text = cripto.Decrypt(dv.Table.Rows[0]["rua"].ToString()); txtAltUf.Text = cripto.Decrypt(dv.Table.Rows[0]["uf"].ToString()); txtDtInicio.Text = dv.Table.Rows[0]["dt_inicio"].ToString(); txtDtFim.Text = dv.Table.Rows[0]["data_final"].ToString(); txtAltNum.Text = cripto.Decrypt(dv.Table.Rows[0]["num"].ToString()); txtHrInicio.Text = dv.Table.Rows[0]["hr_inicio"].ToString(); txtHrFim.Text = dv.Table.Rows[0]["hr_final"].ToString(); txtFaet.Text = cripto.Decrypt(dv.Table.Rows[0]["faet"].ToString()); if (cripto.Decrypt(dv.Table.Rows[0]["tipo"].ToString()) == "Beneficente") ddlAltTipo.SelectedIndex = 1; if (cripto.Decrypt(dv.Table.Rows[0]["tipo"].ToString()) == "Games") ddlAltTipo.SelectedIndex = 2; if (cripto.Decrypt(dv.Table.Rows[0]["tipo"].ToString()) == "Workshop") ddlAltTipo.SelectedIndex = 3; if (cripto.Decrypt(dv.Table.Rows[0]["tipo"].ToString()) == "Boate") ddlAltTipo.SelectedIndex = 4; if (cripto.Decrypt(dv.Table.Rows[0]["tipo"].ToString()) == "Show") ddlAltTipo.SelectedIndex = 5; if (cripto.Decrypt(dv.Table.Rows[0]["tipo"].ToString()) == "Social") ddlAltTipo.SelectedIndex = 6; if (cripto.Decrypt(dv.Table.Rows[0]["tipo"].ToString()) == "Palestra - Livre") ddlAltTipo.SelectedIndex = 7; if (cripto.Decrypt(dv.Table.Rows[0]["tipo"].ToString()) == "Palestra - Para Maiores de 18 Anos") ddlAltTipo.SelectedIndex = 8; if (cripto.Decrypt(dv.Table.Rows[0]["tipo"].ToString()) == "Stand Up - Livre") ddlAltTipo.SelectedIndex = 9; if (cripto.Decrypt(dv.Table.Rows[0]["tipo"].ToString()) == "Stand Up - Para Maiores de 18 Anos") ddlAltTipo.SelectedIndex = 10; if (cripto.Decrypt(dv.Table.Rows[0]["status"].ToString()) == "a") { ddlAltStatus.SelectedIndex = 1; Session["getStatus"] = "0"; } if (cripto.Decrypt(dv.Table.Rows[0]["status"].ToString()) == "p") { ddlAltStatus.SelectedIndex = 2; Session["getStatus"] = "1"; } if (cripto.Decrypt(dv.Table.Rows[0]["subtipo"].ToString()) == "Sertanejo") ddlSubtipoEvento.SelectedIndex = 1; if (cripto.Decrypt(dv.Table.Rows[0]["subtipo"].ToString()) == "Baile") ddlSubtipoEvento.SelectedIndex = 2; if (cripto.Decrypt(dv.Table.Rows[0]["subtipo"].ToString()) == "Rock") ddlSubtipoEvento.SelectedIndex = 3; if (cripto.Decrypt(dv.Table.Rows[0]["subtipo"].ToString()) == "Empresarial") ddlSubtipoEvento.SelectedIndex = 4; if (cripto.Decrypt(dv.Table.Rows[0]["subtipo"].ToString()) == "Jazz") ddlSubtipoEvento.SelectedIndex = 5; if (cripto.Decrypt(dv.Table.Rows[0]["subtipo"].ToString()) == "Clube de Dança") ddlSubtipoEvento.SelectedIndex = 6; if (cripto.Decrypt(dv.Table.Rows[0]["subtipo"].ToString()) == "Motivacional") ddlSubtipoEvento.SelectedIndex = 7; if (cripto.Decrypt(dv.Table.Rows[0]["subtipo"].ToString()) == "Apresentação/Exibição") ddlSubtipoEvento.SelectedIndex = 8; if (cripto.Decrypt(dv.Table.Rows[0]["subtipo"].ToString()) == "Jantar") ddlSubtipoEvento.SelectedIndex = 9; if (cripto.Decrypt(dv.Table.Rows[0]["subtipo"].ToString()) == "Pop") ddlSubtipoEvento.SelectedIndex = 10; } } } protected void btnAlterar_Click(object sender, EventArgs e) { try { String nomeArq = Path.GetFileName(fuAltImg.FileName), urlBD; if (nomeArq != "") { fuAltImg.SaveAs(Server.MapPath("\\img\\uploaded\\" + nomeArq)); urlBD = cripto.Encrypt(nomeArq); } else { DataView dv = (DataView)sqlVisEventos.Select(DataSourceSelectArguments.Empty); urlBD = dv.Table.Rows[0]["img"].ToString(); } sqlVisEventos.UpdateParameters["img"].DefaultValue = urlBD; try { DateTime dtI = Convert.ToDateTime(txtDtInicio.Text); String dtICorreta = dtI.ToString("yyyy/MM/dd"); DateTime hrI = Convert.ToDateTime(txtHrInicio.Text); DateTime dtF = Convert.ToDateTime(txtDtFim.Text); String dtFCorreta = dtF.ToString("yyyy/MM/dd"); DateTime hrF = Convert.ToDateTime(txtHrFim.Text); if (dtF < dtI || dtF == dtI && hrF <= hrI || (int)dtI.Year < DateTime.Now.Year || (int)dtI.Day < DateTime.Now.Day && (int)dtI.Month <= DateTime.Now.Month && (int)dtI.Year <= DateTime.Now.Year || (int)dtI.Day == DateTime.Now.Day && (int)dtI.Year == DateTime.Now.Year && (int)dtI.Month < DateTime.Now.Month) { lblResp.Text = "INSIRA DATA E/OU HORA CORRETOS!"; txtDtInicio.Text = string.Empty; txtDtInicio.BorderColor = Color.Red; txtDtFim.Text = string.Empty; txtDtFim.BorderColor = Color.Red; txtHrFim.Text = string.Empty; txtHrFim.BorderColor = Color.Red; txtHrInicio.Text = string.Empty; txtHrInicio.BorderColor = Color.Red; } else { sqlVisEventos.UpdateParameters["nome"].DefaultValue = cripto.Encrypt(txtAltNome.Text); sqlVisEventos.UpdateParameters["uf"].DefaultValue = cripto.Encrypt(txtAltUf.Text); sqlVisEventos.UpdateParameters["cid"].DefaultValue = cripto.Encrypt(txtAltCidade.Text); sqlVisEventos.UpdateParameters["num"].DefaultValue = cripto.Encrypt(txtAltNum.Text); sqlVisEventos.UpdateParameters["rua"].DefaultValue = cripto.Encrypt(txtAltRua.Text); sqlVisEventos.UpdateParameters["local"].DefaultValue = cripto.Encrypt(txtAltLocal.Text); sqlVisEventos.UpdateParameters["detalhes"].DefaultValue = cripto.Encrypt(txtAltDetalhes.Text); sqlVisEventos.UpdateParameters["startdt"].DefaultValue = dtICorreta; sqlVisEventos.UpdateParameters["starthr"].DefaultValue = txtHrInicio.Text; sqlVisEventos.UpdateParameters["fimdt"].DefaultValue = dtFCorreta; sqlVisEventos.UpdateParameters["fimhr"].DefaultValue = txtHrFim.Text; aud_emp(); if (ddlAltStatus.SelectedIndex == 1) { sqlAudEmp.Insert(); sqlVisEventos.Update(); Response.Redirect("empEventos.aspx"); } if (ddlAltStatus.SelectedIndex == 2) { Session["startdt"] = dtICorreta; Session["fimdt"] = dtFCorreta; Session["starthr"] = txtHrInicio.Text; Session["fimhr"] = txtHrFim.Text; Session["evento"] = cripto.Encrypt(txtAltNome.Text); Session["uf"] = cripto.Encrypt(txtAltUf.Text); Session["rua"] = cripto.Encrypt(txtAltRua.Text); Session["num"] = cripto.Encrypt(txtAltNum.Text); Session["cid"] = cripto.Encrypt(txtAltCidade.Text); Session["local"] = cripto.Encrypt(txtAltLocal.Text); Session["detalhes"] = cripto.Encrypt(txtAltDetalhes.Text); Session["tipo"] = ddlAltTipo.SelectedIndex; Session["subtipo"] = ddlSubtipoEvento.SelectedIndex; Session["status"] = ddlAltStatus.SelectedIndex; Session["img"] = urlBD; Response.Redirect("empAltIngresso.aspx"); } } } catch { txtDtInicio.Text = string.Empty; txtDtInicio.BorderColor = Color.Red; txtDtFim.Text = string.Empty; txtDtFim.BorderColor = Color.Red; txtHrFim.Text = string.Empty; txtHrFim.BorderColor = Color.Red; txtHrInicio.Text = string.Empty; txtHrInicio.BorderColor = Color.Red; } } catch (System.Data.SqlClient.SqlException) { Email.erro("empVisEvento.aspx"); lblResp.Text = "ERRO! TENTE NOVAMENTE MAIS TARDE."; } } private void clear(){txtAltNome.Text = string.Empty;txtAltCidade.Text = string.Empty;txtAltDetalhes.Text = string.Empty;txtAltNum.Text = string.Empty;txtAltRua.Text = string.Empty;txtAltUf.Text = string.Empty;txtAltLocal.Text = string.Empty;txtHrInicio.Text = string.Empty;txtHrFim.Text = string.Empty;txtDtInicio.Text = string.Empty;txtDtFim.Text = string.Empty;ddlAltStatus.SelectedIndex = 0;ddlAltTipo.SelectedIndex = 0;ddlSubtipoEvento.SelectedIndex = 0;imgEvento.ImageUrl = "~\\img\\uploaded\\semimagem.jpg";txtFaet.Text = string.Empty;lblResp.Text = string.Empty;txtAltNome.BorderColor = Color.Empty;txtDtInicio.BorderColor = Color.Empty;txtDtFim.BorderColor = Color.Empty;txtHrInicio.BorderColor = Color.Empty;txtHrFim.BorderColor = Color.Empty;} public void aud_emp() { sqlAudEmp.InsertParameters["id"].DefaultValue = Session["idEmp"].ToString(); sqlAudEmp.InsertParameters["table"].DefaultValue = "evento"; sqlAudEmp.InsertParameters["desc"].DefaultValue = "Alterou um evento"; string hr = DateTime.Now.Hour.ToString() + ":" + DateTime.Now.Minute.ToString(); sqlAudEmp.InsertParameters["hr"].DefaultValue = hr; string data = DateTime.Now.Date.ToShortDateString(); sqlAudEmp.InsertParameters["data"].DefaultValue = data; } }