using System;using System.Collections.Generic;using System.Linq;using System.Web;using System.Web.UI;using System.Web.UI.WebControls;using System.Data;using System.IO;using System.Drawing; public partial class esqSenha : System.Web.UI.Page { Criptografia cripto = new Criptografia("NEON"); protected void Page_Load(object sender, EventArgs e){} protected void btnEnviar_Click(object sender, EventArgs e) { var random = new Random(); var charM = "QWERTYUIOPASDFGHJKLZXCVBNM";var charm = "qwertyuiopasdfghjklzxcvbnm";var nums = "1234567890";var specials = "!@#$%&*_"; var stringaoM = new char[1];var stringaom = new char[1];var stringaonum = new char[1];var stringaospec = new char[1]; for (int i = 0; i < 1; i++) { stringaoM[i] = charM[random.Next(charM.Length)];stringaom[i] = charm[random.Next(charm.Length)];stringaonum[i] = nums[random.Next(nums.Length)];stringaospec[i] = specials[random.Next(specials.Length)]; } string stringao = new String(stringaoM) + new String(stringaom)+ new String(stringaonum) + new String(stringaospec); string stringao2 = stringao.Replace("\0", ""); for (int i = 0; i < 1; i++) { stringaoM[i] = charM[random.Next(charM.Length)];stringaom[i] = charm[random.Next(charm.Length)];stringaonum[i] = nums[random.Next(nums.Length)];stringaospec[i] = specials[random.Next(specials.Length)]; } string stringaoFinal = stringao2 + new String(stringaoM) + new String(stringaom)+ new String(stringaonum) + new String(stringaospec); string stringFinaldoFinal = stringaoFinal.Replace("\0", ""); try { sqlEmailAudUsu.SelectParameters["email"].DefaultValue = cripto.Encrypt(txtEmail.Text); sqlEmailAudEmp.SelectParameters["email"].DefaultValue = cripto.Encrypt(txtEmail.Text); sqlEmailAudUsu.UpdateParameters["email"].DefaultValue = cripto.Encrypt(txtEmail.Text); sqlEmailAudUsu.UpdateParameters["senha"].DefaultValue = cripto.Encrypt(stringFinaldoFinal); sqlEmailAudEmp.UpdateParameters["email"].DefaultValue = cripto.Encrypt(txtEmail.Text); sqlEmailAudEmp.UpdateParameters["senha"].DefaultValue = cripto.Encrypt(stringFinaldoFinal); sqlAudLogin.SelectParameters["email"].DefaultValue = cripto.Encrypt(txtEmail.Text); sqlAudEmp.SelectParameters["email"].DefaultValue = cripto.Encrypt(txtEmail.Text); sqlGetNameUsu.SelectParameters["email"].DefaultValue = cripto.Encrypt(txtEmail.Text); sqlGetNameEmp.SelectParameters["email"].DefaultValue = cripto.Encrypt(txtEmail.Text); DataView dv = (DataView)sqlEmailAudUsu.Select(DataSourceSelectArguments.Empty); DataView dv2 = (DataView)sqlEmailAudEmp.Select(DataSourceSelectArguments.Empty); DataView dv3=(DataView)sqlAudLogin.Select(DataSourceSelectArguments.Empty); DataView dv4=(DataView)sqlAudEmp.Select(DataSourceSelectArguments.Empty); DataView dv5 =(DataView)sqlGetNameUsu.Select(DataSourceSelectArguments.Empty); DataView dv6 =(DataView)sqlGetNameEmp.Select(DataSourceSelectArguments.Empty); if (dv.Table.Rows.Count > 0) { Email.senhaEsq(txtEmail.Text, cripto.Decrypt(dv5.Table.Rows[0]["nome_usu"].ToString()), cripto.Decrypt(dv.Table.Rows[0]["email"].ToString()), stringFinaldoFinal); txtEmail.BorderColor = Color.Empty; txtEmail.Text = string.Empty; lblErro.ForeColor = Color.Cyan; lblErro.Text = "EMAIL ENVIADO!"; sqlEmailAudUsu.Update(); Session["getIdUsu"] = dv3.Table.Rows[0]["id_usu"].ToString(); aud_usu(); sqlEmailAudUsu.Insert(); } else { Email.senhaEsq(txtEmail.Text, cripto.Decrypt(dv6.Table.Rows[0]["responsavel_emp"].ToString()),cripto.Decrypt(dv2.Table.Rows[0]["email"].ToString()), stringFinaldoFinal); txtEmail.BorderColor = Color.Empty; txtEmail.Text = string.Empty; lblErro.ForeColor = Color.Cyan; lblErro.Text = "EMAIL ENVIADO!"; sqlEmailAudEmp.Update(); Session["idEmp"] = dv4.Table.Rows[0]["id_emp"].ToString(); aud_emp(); sqlEmailAudEmp.Insert(); } } catch { if (txtEmail.Text == string.Empty) { txtEmail.BorderColor = Color.Red; txtEmail.Text = string.Empty; lblErro.ForeColor = Color.Red; lblErro.Text = "DIGITE SEU EMAIL!"; } else if (txtEmail.Text != string.Empty) { txtEmail.BorderColor = Color.Red; txtEmail.Text = string.Empty; lblErro.ForeColor = Color.Red; lblErro.Text = "EMAIL NÃO CADASTRADO EM NOSSO SISTEMA! <br><a href='CadastroUsuario.aspx' style='color:cyan'>Cadastro de Usuário</a> <br><a href='CadastroEmp.aspx' style='color:cyan'>Cadastro de Empresas</a>"; } else { lblErro.ForeColor = Color.Red; lblErro.Text = "ERRO! TENTE NOVAMENTE MAIS TARDE."; Email.erro("esqSenha.aspx"); } } } private void aud_usu() { sqlEmailAudUsu.InsertParameters["id"].DefaultValue = Session["getIdUsu"].ToString(); sqlEmailAudUsu.InsertParameters["table"].DefaultValue = "usuario"; sqlEmailAudUsu.InsertParameters["desc"].DefaultValue = "Enviou Email para Esqueceu a Senha"; string hr = DateTime.Now.Hour.ToString() + ":" + DateTime.Now.Minute.ToString("0#"); sqlEmailAudUsu.InsertParameters["hr"].DefaultValue = hr; string data = DateTime.Now.Date.ToShortDateString(); sqlEmailAudUsu.InsertParameters["data"].DefaultValue = data; } private void aud_emp() { sqlEmailAudEmp.InsertParameters["id"].DefaultValue = Session["idEmp"].ToString(); sqlEmailAudEmp.InsertParameters["table"].DefaultValue = "cliente_emp"; sqlEmailAudEmp.InsertParameters["desc"].DefaultValue = "Enviou Email para Esqueceu a Senha"; string hr = DateTime.Now.Hour.ToString() + ":" + DateTime.Now.Minute.ToString("0#"); sqlEmailAudEmp.InsertParameters["hr"].DefaultValue = hr; string data = DateTime.Now.Date.ToShortDateString(); sqlEmailAudEmp.InsertParameters["data"].DefaultValue = data; } }